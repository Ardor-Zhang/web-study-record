[toc]

# Monorepo

> 译为单仓

你所需要了解的关于 Monorepo 的一切，以及业界构建 Monorepo 的工具。

## 1. 前言

Monorepo 现在可谓是相当的热门，尤其是在 Web 开发者中。

本文的目的就是为了帮助开发人员了解 Monorepo 是什么，它具有哪些优势，能带来什么好处，以及详细介绍业界能够便捷和高效的构建 Monorepo 的工具。

业界已经有许多优秀的 Monorepo 工具，这些工具分别由不同的团队打造，具有不同的理念。本文将尽最大努力来客观地阐述每种工具，如果有任何的错误，欢迎指出！

本文关注的 Monorepo 工具有：Bazel（Google 出品）、Gradle Build Tool（Gradle 出品）、Lage（Microsoft 出品）、Lerna、Nx（Nrwl 出品）、Rush（Microsoft 出品）和 Turborepo（Vercel 出品）。

> 选择依据：在 Web 开发社区中的受欢迎程度。

## 2. 什么是 Monorepo

Monorepo 是指包含多个不同项目的单个仓库，且这些项目之间具有良好的关系。

总览业界稳定运行的 Monorepo 工具，这应是对 Monorepo 最一致、最准确的陈述。

### 2.1 不仅仅是 “代码托管”

如果一个仓库中包含着多个项目，那么这个仓库一定起着 “代码托管” 能力的作用，但是如果这些项目之间没有良好的关系，仅仅是堆砌在一起，那么并不能称这个仓库为 Monorepo。

同样，如果一个仓库包含一个大规模的应用程序，而没有对可复用部分进行封装和拆分，那么它只是一个很大的仓库。你可以给它起个别致的名字，比如 “garganturepo”，但很抱歉，它不是 Monorepo。

通常大家谈到 Monorepo 时首先想到的就是这样的仓库将会是一个巨石应用 (Monolith)，真的是这样吗？继续阅读，你会发现一个好的 Monorepo 与巨石应用有着天壤之别。

### 2.2 Monorepo != Monolith



#### 2.2.1 Polyrepo

> 可译为多仓

为了便于讨论，我们假设和 Monorepo 相对的是 Polyrepo。Polyrepo 是当前开发应用的常用模式：每个团队、每个应用或每个项目都有各自的仓库。每个仓库都配备了所需的构建配置、环境以及流水线。

行业中使用 Polyrepo 这种开发模式有一个重要原因：团队能够高度自治。例如，团队可以自主决定使用何种第三方库，何种方式以及何时部署和发布自己的应用，谁可以向仓库贡献代码以及使用这些代码。

从团队自己的角度来看，是的，这些都是好事，但是为什么各个团队要做不同的事情呢？但从整体来看，这种高度自治是由仓库隔离所带来的，而隔离一定会损害团队之间的协作，更具体地说，以下这些点都是 Polyrepo 环境的常见缺点：

1. 繁琐的代码共享

   要跨仓共享代码，通常的做法是为期望共享的代码创建一个新的仓库，新的仓库必然需要对应的工具和 CI、代码共享规范以及打包发布，这样其它仓库才可以去使用它，代码才得以共享。除此之外，其它仓库在引用这些代码还需要考虑是否需要处理与这个仓库所不兼容的三方库等等。

2. 大量的代码重复

   除了专门建设公共设施的团队外，几乎不会有团队想要去经历——新建和维护一个用于代码共享的仓库所带来的——麻烦，因为相较于维护一个这样的仓库，直接在自己的仓库中去实现这些公共服务和组件反而更简单。但是这样做不仅会浪费前期搭建项目的时间，而且，随着公共组件和服务的增加和变化，这样还会增加项目维护的成本、降低项目的安全性以及增大质量控制的难度。

3. 共享仓库的变更为多方带来的高额成本

   如果共享仓库中发生了一个严重的错误或者破坏性的升级：依赖此仓库的所有项目均需要对此依赖包进行升级、重新开发或测试以及重新构建打包发布才能真正生效。更不用说这个仓库本身的版本控制和发布软件包的一系列工作了。

4. 不一致的工具

   每个项目组或者团队都会偏向于使用自己的一组命令来运行测试、构建、本地开发、语法检查以及部署等等。这些的不一致性将会增加开发者在多项目之间切换时使用的心智负担。

#### 2.2.2 Monorepo

使用 Monorepo 能够很好的解决 Polyrepo 带来的问题，那 Monorepo 如何解决的呢？

1. 没有创建新项目的开销

   使用现有的CI设置，如果所有使用者都在同一个repo中，则无需发布版本化的软件包

2. 跨项目的原子提交
   在每一次承诺中，每件事都在一起工作。在同一个提交中修复所有内容时，不存在破坏性更改。

3. 一切的一个版本
   由于项目依赖于第三方库的冲突版本，因此无需担心不兼容。

4. 开发者移动性
   获得使用不同工具和技术编写和测试应用程序的一致方法。开发人员可以自信地为其他团队的应用程序做出贡献，并验证他们的更改是安全的。



在polyrepo工作时，我们可能会遇到非常棘手的情况。但monorepo如何帮助解决所有这些问题呢？



















